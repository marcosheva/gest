<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Magazzino</title>
    <!-- Carica Bootstrap da CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Carica Font Awesome da CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
        }

        .container {
            margin-top: 50px;
            max-width: 800px;
        }

        h1, h4 {
            text-align: center;
            color: #007bff;
        }

        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .alert {
            display: none;
        }

        .table th {
            background-color: #007bff;
            color: white;
        }

        .table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .action-icons i {
            font-size: 1.2rem;
            margin-right: 10px;
            cursor: pointer;
        }

        .action-icons .edit {
            color: #ffc107;
        }

        .action-icons .edit:hover {
            color: #ff9800;
        }

        .action-icons .delete {
            color: #dc3545;
        }

        .action-icons .delete:hover {
            color: #ff3d00;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card p-4">
        <h1>Gestionale Magazzino</h1>

        <!-- Form per aggiungere prodotto -->
        <h4 class="mt-4">Aggiungi Prodotto</h4>
        <form id="addProductForm">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome Prodotto</label>
                <input type="text" class="form-control" id="nome" placeholder="Nome del prodotto" required>
            </div>
            <div class="mb-3">
                <label for="marca" class="form-label">Marca</label>
                <input type="text" class="form-control" id="marca" placeholder="Marca del prodotto" required>
            </div>
            <div class="mb-3">
                <label for="quantita" class="form-label">Quantità</label>
                <input type="number" class="form-control" id="quantita" placeholder="Quantità del prodotto" required>
            </div>
            <button type="submit" class="btn btn-primary">Aggiungi Prodotto</button>
        </form>

        <!-- Messaggio di successo o errore -->
        <div id="message" class="alert alert-success mt-4" role="alert"></div>

        <!-- Tabella per visualizzare i prodotti -->
        <h4 class="mt-4">Prodotti nel Magazzino</h4>
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Marca</th>
                    <th>Quantità</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody id="prodottiTable">
                <!-- I dati dei prodotti vengono caricati qui tramite JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Aggiungi il JS di Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('addProductForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
            // Preleva i dati dal form
            const nome = document.getElementById('nome').value;
            const marca = document.getElementById('marca').value;
            const quantita = document.getElementById('quantita').value;

            // Invio dati al server
            const response = await fetch('/aggiungi_prodotto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `nome=${nome}&marca=${marca}&quantita=${quantita}`
            });

            if (!response.ok) {
                throw new Error(`Errore HTTP: ${response.status}`);
            }

            const result = await response.json();

            // Mostra messaggio di successo o errore
            const messageElement = document.getElementById('message');
            messageElement.textContent = result.message;
            messageElement.className = result.success ? 'alert alert-success' : 'alert alert-danger';
            messageElement.style.display = 'block';

            // Carica la lista aggiornata dei prodotti
            caricaProdotti();
        } catch (error) {
            console.error('Errore nell\'aggiunta prodotto:', error);
            const messageElement = document.getElementById('message');
            messageElement.textContent = `❌ Errore nell'aggiunta prodotto: ${error.message}`;
            messageElement.className = 'alert alert-danger';
            messageElement.style.display = 'block';
        }
    });

    async function caricaProdotti() {
        try {
            const response = await fetch('/prodotti');
            
            if (!response.ok) {
                throw new Error(`Errore HTTP: ${response.status}`);
            }
            
            const prodotti = await response.json();
            const tableBody = document.querySelector('#prodottiTable');
            tableBody.innerHTML = '';

            if (prodotti.error) {
                // Mostra messaggio di errore se il database non è disponibile
                const messageElement = document.getElementById('message');
                messageElement.textContent = prodotti.error;
                messageElement.className = 'alert alert-danger';
                messageElement.style.display = 'block';
                return;
            }

            prodotti.forEach(prodotto => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${prodotto.nome}</td>
                    <td>${prodotto.marca}</td>
                    <td>${prodotto.quantita}</td>
                    <td class="action-icons">
                        <i class="fas fa-edit edit" onclick="modificaProdotto('${prodotto.nome}')"></i>
                        <i class="fas fa-trash delete" onclick="rimuoviProdotto('${prodotto.nome}')"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Errore nel caricamento prodotti:', error);
            const messageElement = document.getElementById('message');
            messageElement.textContent = `❌ Errore nel caricamento prodotti: ${error.message}`;
            messageElement.className = 'alert alert-danger';
            messageElement.style.display = 'block';
        }
    }

    async function modificaProdotto(nomeProdotto) {
        const quantita = prompt('Nuova quantità per il prodotto ' + nomeProdotto);

        if (quantita !== null) {
            try {
                const response = await fetch('/modifica_prodotto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `nome=${nomeProdotto}&quantita=${quantita}`
                });

                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }

                const result = await response.json();

                const messageElement = document.getElementById('message');
                messageElement.textContent = result.message;
                messageElement.className = result.success ? 'alert alert-success' : 'alert alert-danger';
                messageElement.style.display = 'block';

                // Ricarica i prodotti
                caricaProdotti();
            } catch (error) {
                console.error('Errore nella modifica prodotto:', error);
                const messageElement = document.getElementById('message');
                messageElement.textContent = `❌ Errore nella modifica prodotto: ${error.message}`;
                messageElement.className = 'alert alert-danger';
                messageElement.style.display = 'block';
            }
        }
    }

    async function rimuoviProdotto(nomeProdotto) {
        const conferma = confirm(`Sei sicuro di voler rimuovere il prodotto '${nomeProdotto}'?`);
        if (conferma) {
            try {
                // Chiamata al backend per rimuovere il prodotto
                const response = await fetch('/rimuovi_prodotto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `nome=${nomeProdotto}`
                });
        
                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }
        
                const result = await response.json();
        
                // Mostra messaggio di successo o errore
                const messageElement = document.getElementById('message');
                messageElement.textContent = result.message;
                messageElement.className = result.success ? 'alert alert-success' : 'alert alert-danger';
                messageElement.style.display = 'block';
        
                // Ricarica la lista aggiornata dei prodotti
                caricaProdotti();
            } catch (error) {
                console.error('Errore nella rimozione prodotto:', error);
                const messageElement = document.getElementById('message');
                messageElement.textContent = `❌ Errore nella rimozione prodotto: ${error.message}`;
                messageElement.className = 'alert alert-danger';
                messageElement.style.display = 'block';
            }
        }
    }
    

    // Carica i prodotti appena la pagina viene caricata
    window.onload = caricaProdotti;
</script>
</body>
</html>
